WITH q1 as
(
    SELECT cust, prod, state, avg(quant) prod_avg
    FROM sales
    GROUP BY cust, prod, state
), 
q2 as (
    SELECT q1.cust, q1.prod, q1.state, prod_avg, avg(quant) other_cust_avg
    FROM sales, q1
    WHERE sales.prod = q1.prod and sales.state = q1.state and sales.cust != q1.cust  
    GROUP BY q1.cust, q1.prod, q1.state, prod_avg
),
q3 as (
    SELECT q2.cust, q2.prod, q2.state, prod_avg, other_cust_avg, avg(quant) other_prod_avg
    FROM sales, q2
    WHERE sales.prod != q2.prod and sales.state = q2.state and sales.cust = q2.cust  
    GROUP BY q2.cust, q2.prod, q2.state, prod_avg, other_cust_avg
)
    SELECT q3.cust customer, q3.prod product, q3.state, prod_avg, other_cust_avg, other_prod_avg, avg(quant) other_state_avg 
    FROM sales, q3
    WHERE sales.prod = q3.prod and sales.state != q3.state and sales.cust = q3.cust  
    GROUP BY q3.cust, q3.prod, q3.state, prod_avg, other_cust_avg, other_prod_avg	