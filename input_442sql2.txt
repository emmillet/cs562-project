WITH q1 as 
(
    SELECT cust, prod, month, avg(quant)
    FROM sales 
    GROUP BY cust, prod, month
),
q2 as (
    -- SELECT x.cust, x.prod, x.month, y.month before_mo, x.avg, y.avg prev_avg
    SELECT x.cust, x.prod, x.month, y.avg prev_avg
    FROM q1 x left join q1 y
    ON x.month - 1 = y.month and x.cust = y.cust and x.prod = y.prod
),
q3 as (
    -- SELECT x.cust, x.prod, x.month, y.month after_mo, x.avg, y.avg after_avg
    SELECT x.cust, x.prod, x.month, y.avg next_avg
    FROM q1 x left join q1 y
    ON x.month + 1 = y.month and x.cust = y.cust and x.prod = y.prod
),
q4 as (
    SELECT q1.cust, q1.prod, q1.month, avg, prev_avg 
    FROM q1, q2
    WHERE q1.cust = q2.cust and q1.prod = q2.prod and q1.month = q2.month
    -- ORDER BY q1.cust, q1.prod, q1.month
)
    SELECT q4.cust customer, q4.prod product, q4.month, prev_avg before_avg, avg during_avg, next_avg after_avg
    FROM q3, q4
    WHERE q3.cust = q4.cust and q3.prod = q4.prod and q3.month = q4.month
    ORDER BY q4.cust, q4.prod, q4.month
